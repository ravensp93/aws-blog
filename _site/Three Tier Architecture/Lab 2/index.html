<!DOCTYPE html> <html lang="en" dir="auto"> <head><meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=no"> <meta name="description" content="Lab 2: Bastion Host Configuration Introduction Blueprint Elastic IP Key Pair Security Group IAM Policy IAM Role Launch Template Auto Scaling Group ..."> <meta name="revised" content="1daa8c3719bbdf340585e65c1bed17983f283207"> <meta name="author" content="RavenSP"> <meta name="generator" content="rundocs/jekyll-rtd-theme v2.0.10"><meta name="theme-color" content="#2980b9"> <title>Lab 2: Bastion Host Configuration 路 AWS Documentation Repository</title> <meta name="twitter:title" content="Lab 2: Bastion Host Configuration 路 AWS Documentation Repository"> <meta name="twitter:description" content="Lab 2: Bastion Host Configuration Introduction Blueprint Elastic IP Key Pair Security Group IAM Policy IAM Role Launch Template Auto Scaling Group ..."> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@RavenSP"> <meta name="twitter:url" content="http://localhost:4000/Three%20Tier%20Architecture/Lab%202/"> <meta name="twitter:creator" content="@rundocs/jekyll-rtd-theme v2.0.10"> <meta property="og:title" content="Lab 2: Bastion Host Configuration 路 AWS Documentation Repository"> <meta property="og:description" content="Lab 2: Bastion Host Configuration Introduction Blueprint Elastic IP Key Pair Security Group IAM Policy IAM Role Launch Template Auto Scaling Group ..."> <meta property="og:locale" content="en"> <meta property="og:url" content="http://localhost:4000/Three%20Tier%20Architecture/Lab%202/"> <meta property="og:type" content="article"> <meta property="article:author" content="RavenSP"> <meta property="article:published_time" content="2020-12-11T02:59:42+08:00"> <meta property="article:modified_time" content="2020-12-11T03:47:52+08:00"> <script type="application/ld+json"> { "@context": "https://schema.org", "@type": "Article", "mainEntityOfPage": { "@type": "WebPage", "@id": "http://localhost:4000/Three%20Tier%20Architecture/Lab%202/" }, "headline": "Lab 2: Bastion Host Configuration 路 AWS Documentation Repository", "image": [], "author": { "@type": "Person", "name": "RavenSP" }, "datePublished": "2020-12-11T02:59:42+08:00", "dateModified": "2020-12-11T03:47:52+08:00", "publisher": { "@type": "User", "name": "RavenSP", "logo": { "@type": "ImageObject", "url": "https://avatars1.githubusercontent.com/u/66004820?v=4" } }, "description": "Lab 2: Bastion Host Configuration Introduction Blueprint Elastic IP Key Pair Security Group IAM Policy IAM Role Launch Template Auto Scaling Group ..." } </script> <link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="canonical" href="http://localhost:4000/Three%20Tier%20Architecture/Lab%202/"><link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg"><link rel="icon" type="image/png" href="/assets/images/favicon-16x16.png" sizes="16x16"> <link rel="icon" type="image/png" href="/assets/images/favicon-32x32.png" sizes="32x32"> <link rel="icon" type="image/png" href="/assets/images/favicon-96x96.png" sizes="96x96"><link rel="mask-icon" href="/assets/images/favicon.svg" color="#2980b9"><link rel="apple-touch-icon" href="/assets/images/apple-touch-icon-300x300.jpg"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.10/assets/css/theme.min.css"><script> window.ui = { title: "AWS Documentation Repository", baseurl: "", i18n: { search_results: "Search Results", search_results_found: "Search finished, found # page(s) matching the search query.", search_results_not_found: "Your search did not match any documents, please make sure that all characters are spelled correctly!" } }; </script> </head> <body class="container"><div class="sidebar-wrap overflow-hidden"> <div class="sidebar height-full overflow-y-scroll overflow-x-hidden"> <div class="header d-flex flex-column p-3 text-center"> <div class="title pb-1"> <a class="h4 no-underline py-1 px-2 rounded-1" href="/" title="A Repository for AWS POCs and Labs"> <i class="fa fa-home"></i> AWS Documentation Repository </a> </div> <span class="version"></span> <form class="search pt-2" action="/search.html" method="get" autocomplete="off"> <input class="form-control input-block input-sm" type="text" name="q" placeholder="Search docs..."> </form> </div> <div class="toctree py-2" data-spy="affix" role="navigation" aria-label="main navigation"> <ul> </ul> <a class="caption d-block text-uppercase no-wrap px-2 py-0" href="/Three%20Tier%20Architecture/"> Three-Tier Infrastructure Setup </a><ul> <li class="toc level-1"> <a class="d-flex flex-items-baseline" href="/Three%20Tier%20Architecture/Lab%201/"> Lab 1: VPC &amp; Subnet Configuration </a><ul> </ul> </li> <li class="toc level-1"> <a class="d-flex flex-items-baseline" href="/Three%20Tier%20Architecture/Lab%202/"> Lab 2: Bastion Host Configuration </a><ul> </ul> </li></ul> <a class="caption d-block text-uppercase no-wrap px-2 py-0" href="/2nd%20Page/"> /2nd%20Page/ </a><ul> </ul> </div> </div> </div> <div class="content-wrap"> <div class="header d-flex flex-justify-between p-2 hide-lg hide-xl" aria-label="top navigation"> <button id="toggle" aria-label="Toggle menu" class="btn-octicon p-2 m-0 text-white" type="button"> <i class="fa fa-bars"></i> </button> <div class="title flex-1 d-flex flex-justify-center"> <a class="h4 no-underline py-1 px-2 rounded-1" href="/">AWS Documentation Repository</a> </div> </div> <div class="content p-3 p-sm-5"> <div class="navigation-top d-flex flex-justify-between"> <ul class="breadcrumb" role="navigation" aria-label="breadcrumbs navigation"> <li class="breadcrumb-item"> <a class="no-underline" href="/" title="/"> <i class="fa fa-home"></i> </a> </li><li class="breadcrumb-item" ><a href="/Three Tier Architecture/">Three Tier Architecture</a></li><li class="breadcrumb-item" ><a href="/Three Tier Architecture/Lab 2/">Lab 2</a></li><li class="breadcrumb-item" aria-current="page">readme.md</li></ul> <a class="edit" href="https://github.com/ravensp93/aws-blog/edit/gh-pages/Three%20Tier%20Architecture/Lab%202/readme.md" title="Edit on GitHub" rel="noreferrer" target="_blank"> <i class="fa fa-edit"></i> </a> </div> <hr> <div role="main" itemscope="itemscope" itemtype="https://schema.org/Article"> <div class="markdown-body" itemprop="articleBody"> <h1 id="lab-2-bastion-host-configuration">Lab 2: Bastion Host Configuration</h1> <ul> <li><a href="#introduction">Introduction</a></li> <li><a href="#blueprint">Blueprint</a></li> <li><a href="#elastic-ip">Elastic IP</a></li> <li><a href="#key-pair">Key Pair</a></li> <li><a href="#security-group">Security Group</a></li> <li><a href="#iam-policy">IAM Policy</a></li> <li><a href="#iam-role">IAM Role</a></li> <li><a href="#launch-template">Launch Template</a></li> <li><a href="#auto-scaling-group">Auto Scaling Group</a></li> <li><a href="#private-key-forwarding">Private Key Forwarding (Putty/Pageant)</a></li> </ul> <h2 id="introduction">Introduction</h2> <p>In this lab, we will configure a bastion host that is singly redundant by leveraging on auto-scaling group.</p> <p>A bastion host is a server whose purpose is to provide access to a private network from an external network, such as the Internet. Because of its exposure to potential attack, a bastion host must minimize the chances of penetration.</p> <h2 id="blueprint">Blueprint</h2> <p align="center"> <img src="blob/lab-2-pic-1.PNG" /> </p> <h2 id="elastic-ip">Elastic IP</h2> <p>An Elastic IP address is a static IPv4 address designed for dynamic cloud computing. By using an Elastic IP address, you can mask the failure of an instance or software by rapidly remapping the address to another instance in your account. An Elastic IP address is allocated to your AWS account, and is yours until you release it.</p> <p>1) In <strong>EC2</strong> service page, navigate to <strong>Elastic IPs</strong> page and click on <strong>Allocate Elastic IP address</strong></p> <p align="center"> <img src="blob/lab-2-pic-2.PNG" /> </p> <p>2) Use <strong>default options</strong> (Use Amazon's Pool of IPv4 Addresses) 3) Click "Allocate"</p> <p align="center"> <img src="blob/lab-2-pic-3.PNG" /> </p> <p><strong>Note: Save the IP Address for accessing the instance and resource ID for cli attachment of elastic IP onto the bastion host later</strong></p> <h2 id="key-pair">Key Pair</h2> <p>A key pair, consisting of a private key and a public key, is a set of security credentials that you use to prove your identity when connecting to an instance.</p> <p>1) In <strong>EC2</strong> service page, navigate to <strong>Key Pairs</strong> page and click on <strong>Create Key Pair</strong></p> <p align="center"> <img src="blob/lab-2-pic-4.PNG" /> </p> <p>2) Tag VPC resource with a <strong>name:</strong> bastion-keys 3) Select <strong>ppk</strong> file format 4) Click <strong>Create Key Pair</strong></p> <p align="center"> <img src="blob/lab-2-pic-32.PNG" /> </p> <p><strong>Note: Key pair will be downloaded automatically on your browser, save it for accessing the bastion host later</strong></p> <h2 id="security-group">Security Group</h2> <p>A security group acts as a virtual firewall for your instance to control inbound and outbound traffic. They can be attached to certain resources such as EC2 on AWS.</p> <p>1) In <strong>EC2</strong> service page, navigate to <strong>Security Group</strong> page and click on <strong>Create security group</strong></p> <p align="center"> <img src="blob/lab-2-pic-5.PNG" /> </p> <p>2) Set <strong>Security Group Name:</strong> Bastion-SecG 3) Set <strong>Description:</strong> Allows SSH For Bastion Host 4) Under <strong>Inbound Rules</strong>, Click <strong>Add rule</strong> 5) Select <strong>Type:</strong> SSH, <strong>Source:</strong> Custom 0.0.0.0/0</p> <ul> <li><strong>Note: Best Practice, the source should be set as trusted IPs only.</strong> 6) Click <strong>Create security group</strong></li> </ul> <p align="center"> <img src="blob/lab-2-pic-6.PNG" /> </p> <h2 id="iam-policy">IAM Policy</h2> <p>A policy defines the AWS permissions that you can assign to a user, group, or role.</p> <p>In this section, we will create a policy to allow our bastion host to handle ElasticIPs resource</p> <p>1) In <strong>IAM</strong> service page, navigate to <strong>Policies</strong> page and click on <strong>Create policy</strong></p> <p align="center"> <img src="blob/lab-2-pic-7.PNG" /> </p> <p>2) Select the <strong>JSON</strong> tab, copy and paste the code below into the editor. The following JSON object denotes an <strong>Allow</strong> for certain actions on other resources (e.g DisassociateAddress)</p> <div class="language-plaintext highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code>{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "ec2:ReleaseAddress",
                "ec2:DisassociateAddress",
                "ec2:DescribeNetworkInterfaces",
                "ec2:AssociateAddress",
                "ec2:AllocateAddress"
            ],
            "Resource": "*"
        }
    ]
}
</code></pre>  </div></div> <p>3) Click <strong>Review policy</strong></p> <p align="center"> <img src="blob/lab-2-pic-8.PNG" /> </p> <p>4) Set <strong>Name:</strong> AllowEC2AccessENI 5) Set <strong>Description:</strong> To Allow EC2 Instances to access ENI resources 6) Click <strong>Create Policy</strong></p> <p align="center"> <img src="blob/lab-2-pic-9.PNG" /> </p> <h2 id="iam-role">IAM Role</h2> <p>IAM roles are a secure way to grant permissions to entities that you trust. Examples of entities include the following:</p> <ul> <li>IAM user in another account</li> <li>Application code running on an EC2 instance that needs to perform actions on AWS resources</li> <li>An AWS service that needs to act on resources in your account to provide its features</li> <li>Users from a corporate directory who use identity federation with SAML</li> </ul> <p>We are going to create a role for our EC2 and attach the previously created policy to it. This will allow any EC2 instances attached with this role to have permission to handle elastic IPs resource</p> <p>1) In <strong>IAM</strong> service page, navigate to <strong>Roles</strong> page and click on <strong>Create Role</strong></p> <p align="center"> <img src="blob/lab-2-pic-10.PNG" /> </p> <p>2) Select <strong>Type</strong> as <strong>AWS service</strong></p> <p align="center"> <img src="blob/lab-2-pic-11.PNG" /> </p> <p>3) Choose and Select <strong>Use Case:</strong> EC2 4) Click <strong>Next: Permissions</strong></p> <p align="center"> <img src="blob/lab-2-pic-12.PNG" /> </p> <p>5) Attach <strong>Permissions policy:</strong> AllowEC2AccessENI</p> <p align="center"> <img src="blob/lab-2-pic-13.PNG" /> </p> <p>6) Set <strong>Role name:</strong> Bastion-ENI 7) Set <strong>Role description:</strong> Allow EC2 Instances to access ENI resources 8) Click <strong>Create role</strong></p> <p align="center"> <img src="blob/lab-2-pic-14.PNG" /> </p> <h2 id="launch-template">Launch Template</h2> <p>1) In <strong>EC2</strong> service page, navigate to <strong>Launch Templates</strong> page and click on <strong>Create launch template</strong></p> <p align="center"> <img src="blob/lab-2-pic-31.PNG" /> </p> <p>2) Set <strong>Launch Template Name:</strong> Bastion-Host-Recovery 3) Select <strong>AMI:</strong> Amazon Linux 2 AMI 4) Select <strong>Instance Type:</strong> t2.micro</p> <p align="center"> <img src="blob/lab-2-pic-15.PNG" /> </p> <p>5) Set <strong>Key pair:</strong> bastion-keys (Previously Created) 6) Set <strong>Security Groups</strong> Bastion-SecG (Previously Created)</p> <p align="center"> <img src="blob/lab-2-pic-16.PNG" /> </p> <p>7) Under <strong>advanced details</strong>, select <strong>IAM Instance profile:</strong> Bastion-ENI (Previously Created)</p> <p align="center"> <img src="blob/lab-2-pic-17.PNG" /> </p> <h3 id="user-data">User Data</h3> <p>When you launch an instance in Amazon EC2, you have the option of passing user data to the instance that can be used to perform common automated configuration tasks and even run scripts after the instance has started</p> <p><strong>We will add a script for the launch template to use during automated EC2 instance creation. The script will use AWS CLI to attach an elastic IP to it. This ensures the bastion host that is created to always have the same IP for access</strong></p> <p>8) Under <strong>User data</strong>, Add the following script. **Note: Change &lt; Your ElasticIP ID &gt; to your previously created elastic IP's resource ID. **</p> <div class="language-plaintext highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code>#!
INSTANCE_ID=`/usr/bin/curl -s http://169.254.169.254/latest/meta-data/instance-id`\
aws ec2 associate-address --instance-id $INSTANCE_ID --allocation-id &lt;Your ElasticIP ID&gt; --allow-reassociation --region ap-southeast-1
</code></pre>  </div></div> <p>9) Click <strong>Create launch template</strong></p> <p align="center"> <img src="blob/lab-2-pic-18.PNG" /> </p> <h2 id="auto-scaling-group">Auto Scaling Group</h2> <p>1) In <strong>EC2</strong> service page, navigate to <strong>Auto Scaling Group</strong> page and click on <strong>Create An Auto Scaling group</strong></p> <p align="center"> <img src="blob/lab-2-pic-19.PNG" /> </p> <p>2) Set <strong>Auto Scaling Group name:</strong> Bastion-Host-Recovery 3) Select <strong>Launch Template:</strong> Bastion-Host-Recovery 4) Click <strong>Next</strong></p> <p align="center"> <img src="blob/lab-2-pic-20.PNG" /> </p> <p>5) Select <strong>VPC:</strong> 3-tier-vpc 6) Select <strong>Subnets:</strong> public-subnet-1 &amp; public-subnet-2 7) Click <strong>Next</strong></p> <p align="center"> <img src="blob/lab-2-pic-21.PNG" /> </p> <p>8) Leave Options Default 9) Click <strong>Next</strong></p> <p align="center"> <img src="blob/lab-2-pic-22.PNG" /> </p> <p>10) Leave Options Default 11) Click <strong>Next</strong></p> <p><strong>Note: Setting 1/1/1 capacity will ensure there is at least one bastion host up at a time</strong></p> <p align="center"> <img src="blob/lab-2-pic-23.PNG" /> </p> <p>12) Leave Options Default 13) Click <strong>Next</strong></p> <p align="center"> <img src="blob/lab-2-pic-24.PNG" /> </p> <p>14) <strong>Optional</strong> to add <strong>Tag:</strong> Bastion-ASG 15) Click <strong>Next</strong></p> <p align="center"> <img src="blob/lab-2-pic-25.PNG" /> </p> <p>16) Click <strong>Create Auto Scaling Group</strong></p> <p align="center"> <img src="blob/lab-2-pic-26.PNG" /> </p> <h2 id="private-key-forwarding-puttypageant">Private Key Forwarding (Putty/Pageant)</h2> <p>For Secure Connection to Linux Instances Running in a Private Amazon VPC through Bastion Host https://aws.amazon.com/blogs/security/securely-connect-to-linux-instances-running-in-a-private-amazon-vpc/</p> <p>Download Putty &amp; Pageant: https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html</p> <p>You can SSH to any Instances as long as the private key is added into <strong>Pageant</strong></p> <p>1) Open <strong>Pageant</strong>, add <strong>private key (ppk)</strong> assigned to EC2 Instances in Launch Template</p> <p align="center"> <img src="blob/lab-2-pic-27.PNG" /> </p> <p>2) Open <strong>Putty</strong>, Under <strong>Conncetion &gt; SSH &gt; Auth</strong>, Allow <strong>Agent-forwarding</strong> in Putty</p> <p align="center"> <img src="blob/lab-2-pic-28.PNG" /> </p> <p>3) In <strong>Putty</strong>, Under <strong>Session</strong>, Specify <strong>Hostname</strong> as the ec2-user@{bastion host elastic IP}</p> <p align="center"> <img src="blob/lab-2-pic-29.PNG" /> </p> <p>4) Click <strong>Open</strong></p> <p align="center"> <img src="blob/lab-2-pic-30.PNG" /> </p> </div> </div> <hr> <div class="copyright text-center text-gray" role="contentinfo"> <i class="fa fa-copyright"></i> <span class="time">2020,</span> <a class="text-gray" href="https://github.com/ravensp93" rel="noreferrer" target="_blank">RavenSP</a> Revision <a class="text-gray" href="https://github.com/ravensp93/aws-blog/commit/1daa8c3719bbdf340585e65c1bed17983f283207" title="1daa8c3719bbdf340585e65c1bed17983f283207" rel="noreferrer" target="_blank">1daa8c3</a> <br> <div class="generator"> Built with <a href="https://pages.github.com" rel="noreferrer" target="_blank" title="github-pages v209">GitHub Pages</a> using a <a href="https://github.com/rundocs/jekyll-rtd-theme" rel="noreferrer" target="_blank" title="rundocs/jekyll-rtd-theme v2.0.10">theme</a> provided by <a href="https://rundocs.io" rel="noreferrer" target="_blank">RunDocs</a>. </div> </div> </div> </div> <div class="addons-wrap d-flex flex-column overflow-y-auto"> <div class="status d-flex flex-justify-between p-2"> <div class="title p-1"> <i class="fa fa-book"></i> AWS Documentation Repository </div> <div class="branch p-1"> <span class="name"> gh-pages </span> <i class="fa fa-caret-down"></i> </div> </div> <div class="addons d-flex flex-column height-full p-2 d-none"> <dl> <dt>GitHub</dt> <dd> <a href="https://github.com/ravensp93/aws-blog" title="Stars: 0"> <i class="fa fa-github"></i> Homepage </a> </dd> <dd> <a href="https://github.com/ravensp93/aws-blog/issues" title="Open issues: 0"> <i class="fa fa-question-circle-o"></i> Issues </a> </dd> <dd> <a href="https://github.com/ravensp93/aws-blog/zipball/gh-pages" title="Size: 0 Kb"> <i class="fa fa-download"></i> Download </a> </dd> </dl> <hr> <div class="license f6 pb-2"> This <a href="/" title="AWS Documentation Repository">Software</a> is under the terms of <a href="https://github.com/ravensp93/aws-blog">The Unlicense</a>. </div> </div> </div> <script src="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.10/assets/js/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.10/assets/js/theme.min.js"></script> </body> </html>